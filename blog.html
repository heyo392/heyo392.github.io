<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Blog</title>
    
    <link rel="stylesheet" href="./styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
  </head>
  <body>
    <header class="topbar">
      <div class="container bar-inner">
        <nav class="toplinks" aria-label="Site">
          <a href="index.html">Home</a>
          <a href="projects.html">Projects</a>
          <a href="gallery.html">Gallery</a>
          <a href="blog.html" aria-current="page">Blog</a>
        </nav>
        <div class="icons">
          <a class="icon" href="https://www.linkedin.com/in/dzhang17" aria-label="LinkedIn" target="_blank" rel="noreferrer noopener">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M4.983 3.5C4.983 4.88 3.88 6 2.5 6S0 4.88 0 3.5 1.12 1 2.5 1s2.483 1.12 2.483 2.5zM.24 8.339h4.52v13.36H.24V8.339zM8.339 8.339h4.33v1.827h.061c.603-1.144 2.077-2.353 4.277-2.353 4.573 0 5.418 3.01 5.418 6.926v7.96h-4.708v-7.06c0-1.685-.03-3.853-2.348-3.853-2.35 0-2.708 1.834-2.708 3.732v7.181H8.339V8.339z"/></svg>
          </a>
          <a class="icon" href="https://github.com/heyo392" aria-label="GitHub" target="_blank" rel="noreferrer noopener">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2a10 10 0 0 0-3.162 19.492c.5.092.684-.216.684-.48 0-.237-.009-.866-.013-1.7-2.782.603-3.369-1.342-3.369-1.342-.455-1.156-1.11-1.464-1.11-1.464-.908-.62.069-.607.069-.607 1.004.07 1.532 1.032 1.532 1.032.892 1.529 2.341 1.088 2.91.833.091-.646.35-1.088.636-1.339-2.221-.253-4.555-1.111-4.555-4.944 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.272.098-2.65 0 0 .84-.269 2.75 1.025A9.564 9.564 0 0 1 12 7.07c.851.004 1.707.115 2.507.337 1.909-1.294 2.748-1.025 2.748-1.025.546 1.378.203 2.397.1 2.65.64.699 1.028 1.592 1.028 2.683 0 3.842-2.338 4.688-4.566 4.937.359.309.679.919.679 1.852 0 1.336-.012 2.415-.012 2.743 0 .266.18.576.69.478A10 10 0 0 0 12 2z"/></svg>
          </a>
          <a class="icon" href="./assets/DavidZhangResume.pdf" aria-label="CV / Resume" target="_blank" rel="noreferrer noopener">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm1 7h5l-5-5v5zM8 12h8v2H8v-2zm0 4h8v2H8v-2z"/>
            </svg>
          </a>
        </div>
      </div>
    </header>

    <main class="container section">
      <h1 class="page-title">Blog</h1>
      <div id="blog-root" class="card">
        <p class="muted">Loading…</p>
      </div>
    </main>

    <script src="./script.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" defer></script>
    <script defer>
      (function () {
        const root = document.getElementById('blog-root');
        if (!root) {
          throw new Error('Missing #blog-root');
        }

        const params = new URLSearchParams(window.location.search);
        const slug = params.get('post');
        const manifestUrl = './assets/blog/manifest.json';

        if (window.marked && typeof window.marked.setOptions === 'function') {
          window.marked.setOptions({ gfm: true, breaks: true });
        }

        async function fetchJson(url) {
          const res = await fetch(url, { cache: 'no-cache' });
          if (!res.ok) throw new Error(`Request failed ${res.status} ${url}`);
          return res.json();
        }

        async function fetchText(url) {
          const res = await fetch(url, { cache: 'no-cache' });
          if (!res.ok) throw new Error(`Request failed ${res.status} ${url}`);
          return res.text();
        }

        function renderList(posts) {
          if (!Array.isArray(posts)) throw new Error('Invalid manifest format (expected array)');
          if (posts.length === 0) {
            root.innerHTML = '<p class="muted">No posts yet.</p>';
            return;
          }
          const items = posts.map(p => {
            if (!p || typeof p.slug !== 'string' || typeof p.title !== 'string') {
              throw new Error('Invalid post entry in manifest');
            }
            const date = p.date ? `<div class="muted">${p.date}</div>` : '';
            const summary = p.summary ? `<p>${p.summary}</p>` : '';
            return `
              <article class="card" style="margin: 0 0 16px 0;">
                <h2 style="margin: 0 0 6px 0;"><a href="blog.html?post=${encodeURIComponent(p.slug)}">${p.title}</a></h2>
                ${date}
                ${summary}
              </article>
            `;
          }).join('');
          root.innerHTML = items;
        }

        async function renderPost(slug, posts) {
          if (!slug) throw new Error('Missing slug');
          const post = posts.find(p => p.slug === slug);
          if (!post) {
            root.innerHTML = `<p class="muted">Post not found.</p><p><a href="blog.html">← Back to all posts</a></p>`;
            return;
          }
          if (!post.file) throw new Error('Post missing file in manifest');
          const mdUrl = `./assets/blog/${encodeURIComponent(post.file)}`;
          const text = await fetchText(mdUrl);
          // Strip YAML frontmatter (CRLF tolerant and optional trailing newline)
          const content = text.replace(/^---\r?\n([\s\S]*?)\r?\n---\r?\n?/, '');
          const html = window.marked.parse(content);
          const maybeDate = post.date ? `<div class="muted">${post.date}</div>` : '';
          root.innerHTML = `
            <article class="card">
              <h1 style="margin: 0 0 6px 0;">${post.title}</h1>
              ${maybeDate}
              <div style="margin-top: 14px;">${html}</div>
              <p style="margin-top: 22px;"><a href="blog.html">← Back to all posts</a></p>
            </article>
          `;
          if (typeof window.renderMathInElement === 'function') {
            window.renderMathInElement(root, {
              delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false },
                { left: '\\(', right: '\\)', display: false },
                { left: '\\[', right: '\\]', display: true }
              ],
              throwOnError: false
            });
          }
        }

        (async function init() {
          const posts = await fetchJson(manifestUrl);
          if (slug) {
            await renderPost(slug, posts);
          } else {
            renderList(posts);
          }
        })().catch(err => {
          console.error(err);
          root.innerHTML = `<p class="muted">Error: ${String(err.message || err)}</p>`;
        });
      })();
    </script>
  </body>
  </html>


