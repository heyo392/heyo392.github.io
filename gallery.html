<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gallery</title>
    
    <link rel="stylesheet" href="./styles.css">
  </head>
  <body>
    <header class="topbar">
      <div class="container bar-inner">
        <nav class="toplinks" aria-label="Site">
          <a href="index.html">Home</a>
          <a href="projects.html">Projects</a>
          <a href="gallery.html" aria-current="page">Gallery</a>
          <a href="blog.html">Blog</a>
        </nav>
        <div class="icons">
          <a class="icon" href="https://www.linkedin.com/in/dzhang17" aria-label="LinkedIn" target="_blank" rel="noreferrer noopener">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M4.983 3.5C4.983 4.88 3.88 6 2.5 6S0 4.88 0 3.5 1.12 1 2.5 1s2.483 1.12 2.483 2.5zM.24 8.339h4.52v13.36H.24V8.339zM8.339 8.339h4.33v1.827h.061c.603-1.144 2.077-2.353 4.277-2.353 4.573 0 5.418 3.01 5.418 6.926v7.96h-4.708v-7.06c0-1.685-.03-3.853-2.348-3.853-2.35 0-2.708 1.834-2.708 3.732v7.181H8.339V8.339z"/></svg>
          </a>
          <a class="icon" href="https://github.com/heyo392" aria-label="GitHub" target="_blank" rel="noreferrer noopener">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 2a10 10 0 0 0-3.162 19.492c.5.092.684-.216.684-.48 0-.237-.009-.866-.013-1.7-2.782.603-3.369-1.342-3.369-1.342-.455-1.156-1.11-1.464-1.11-1.464-.908-.62.069-.607.069-.607 1.004.07 1.532 1.032 1.532 1.032.892 1.529 2.341 1.088 2.91.833.091-.646.35-1.088.636-1.339-2.221-.253-4.555-1.111-4.555-4.944 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.272.098-2.65 0 0 .84-.269 2.75 1.025A9.564 9.564 0 0 1 12 7.07c.851.004 1.707.115 2.507.337 1.909-1.294 2.748-1.025 2.748-1.025.546 1.378.203 2.397.1 2.65.64.699 1.028 1.592 1.028 2.683 0 3.842-2.338 4.688-4.566 4.937.359.309.679.919.679 1.852 0 1.336-.012 2.415-.012 2.743 0 .266.18.576.69.478A10 10 0 0 0 12 2z"/></svg>
          </a>
          <a class="icon" href="./assets/DavidZhangResume.pdf" aria-label="CV / Resume" target="_blank" rel="noreferrer noopener">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm1 7h5l-5-5v5zM8 12h8v2H8v-2zm0 4h8v2H8v-2z"/>
            </svg>
          </a>
        </div>
      </div>
    </header>

    <main class="container section">
      <h1 class="page-title">Gallery</h1>
      <p class="muted">budding photographer.</p>

      <div id="gallery-root"></div>
    </main>

    <script src="./script.js" defer></script>
    <script>
      window.addEventListener('DOMContentLoaded', function () {
        (function () {
          var root = document.getElementById('gallery-root');
          if (!root) return;

          fetch('assets/gallery/manifest.json', { cache: 'no-store' })
            .then(function (resp) {
              if (!resp.ok) throw new Error('manifest not found');
              return resp.json();
            })
            .then(function (manifest) {
              if (!manifest || (typeof manifest !== 'object')) throw new Error('Invalid manifest format');
              var albums = Array.isArray(manifest.albums) ? manifest.albums : [];
              var ungrouped = Array.isArray(manifest.ungrouped) ? manifest.ungrouped : [];
              if (albums.length === 0 && ungrouped.length === 0) {
                root.innerHTML = '<p class="muted">Add photos to <code>assets/gallery/</code> to populate the gallery.</p>';
                return;
              }

              // Albums as condensed cards
              if (albums.length) {
                var secA = document.createElement('section');
                var h2A = document.createElement('h2');
                h2A.textContent = 'Albums';
                secA.appendChild(h2A);
                var cards = document.createElement('div');
                cards.className = 'album-grid';
                albums.forEach(function (album) {
                  if (!album || typeof album.folder !== 'string') return;
                  var card = document.createElement('button');
                  card.type = 'button';
                  card.className = 'album-card';
                  var cover = document.createElement('img');
                  var coverFile = album.cover || (album.photos && album.photos[0] && album.photos[0].file) || '';
                  cover.src = coverFile ? ('assets/gallery/' + encodeURI(album.folder + '/' + coverFile)) : '';
                  cover.alt = (album.title || album.folder) + ' cover';
                  cover.loading = 'lazy';
                  card.appendChild(cover);
                  var meta = document.createElement('div');
                  meta.className = 'album-meta';
                  var title = document.createElement('div');
                  title.className = 'album-title';
                  title.textContent = album.title || album.folder;
                  var count = document.createElement('div');
                  count.className = 'album-count';
                  var num = Array.isArray(album.photos) ? album.photos.length : 0;
                  count.textContent = num + ' photo' + (num === 1 ? '' : 's');
                  meta.appendChild(title);
                  meta.appendChild(count);
                  card.appendChild(meta);
                  // removed CTA
                  card.addEventListener('click', function () { showAlbumInline(album); });
                  cards.appendChild(card);
                });
                secA.appendChild(cards);
                root.appendChild(secA);
              }

              // Ungrouped section (shown inline)
              if (ungrouped.length) {
                var secU = document.createElement('section');
                var h2U = document.createElement('h2');
                h2U.textContent = 'Ungrouped';
                secU.appendChild(h2U);
                secU.appendChild(renderGrid(ungrouped, ''));
                root.appendChild(secU);
              }
              // Inline album view container
              var albumView = document.createElement('section');
              albumView.id = 'album-view';
              albumView.style.display = 'none';
              root.appendChild(albumView);

              function showAlbumInline(album) {
                if (!albumView) return;
                // Hide listing sections
                var listSections = root.querySelectorAll('section');
                listSections.forEach(function (s) { if (s !== albumView) s.style.display = 'none'; });
                // Render album contents
                albumView.innerHTML = '';
                var head = document.createElement('div');
                head.className = 'album-head';
                var title = document.createElement('h2');
                title.textContent = album.title || album.folder;
                head.appendChild(title);
                var back = document.createElement('button');
                back.type = 'button';
                back.className = 'button small';
                back.textContent = 'Back to albums';
                back.addEventListener('click', function () { showAlbumsList(); });
                head.appendChild(back);
                albumView.appendChild(head);
                var photos = Array.isArray(album.photos) ? album.photos : [];
                var grid = renderGrid(photos, album.folder);
                grid.classList.add('single');
                albumView.appendChild(grid);
                albumView.style.display = '';
                document.documentElement.classList.add('album-snap');
                document.body.classList.add('album-snap');
                enableAlbumWheelSnap(grid);
                window.scrollTo({ top: 0, behavior: 'smooth' });
              }

              function showAlbumsList() {
                if (albumView) { albumView.style.display = 'none'; albumView.innerHTML = ''; }
                var listSections = root.querySelectorAll('section');
                listSections.forEach(function (s) { if (s !== albumView) s.style.display = ''; });
                document.documentElement.classList.remove('album-snap');
                document.body.classList.remove('album-snap');
                disableAlbumWheelSnap();
                window.scrollTo({ top: 0, behavior: 'smooth' });
              }
            })
            .catch(function (err) {
              console.error('Failed to load gallery manifest:', err);
              root.innerHTML = 'ðŸ“·\u00A0 Unable to load gallery. Ensure <code>assets/gallery/manifest.json</code> exists.';
            });

          function renderGrid(items, prefixFolder) {
            var grid = document.createElement('div');
            grid.className = 'gallery-grid no-crop';
            items.forEach(function (item) {
              if (!item || typeof item.file !== 'string') {
                console.error('Invalid photo entry', item);
                return;
              }
              var caption = (typeof item.caption === 'string') ? item.caption.trim() : '';
              var fig = document.createElement('figure');
              fig.className = 'gallery-item';
              var img = document.createElement('img');
              var src = 'assets/gallery/' + (prefixFolder ? encodeURI(prefixFolder + '/' + item.file) : encodeURI(item.file));
              img.src = src;
              img.alt = caption || '';
              img.loading = 'lazy';
              img.addEventListener('load', function () {
                try {
                  if (img.naturalHeight > img.naturalWidth) { img.classList.add('portrait'); }
                } catch (e) {}
              });
              fig.appendChild(img);
              if (caption) {
                var cap = document.createElement('figcaption');
                cap.textContent = caption;
                fig.appendChild(cap);
              }
              grid.appendChild(fig);
            });
            return grid;
          }


          // Wheel handler: one snap per gesture with deadzone and lock
          var albumWheelHandler = null;
          var albumWheelLock = false;
          function enableAlbumWheelSnap(gridEl) {
            if (!gridEl || albumWheelHandler) return;
            var items = function () { return Array.prototype.slice.call(gridEl.querySelectorAll('.gallery-item')); };
            var header = function () { return document.querySelector('.album-head'); };
            albumWheelHandler = function (e) {
              if (!document.documentElement.classList.contains('album-snap')) return;
              if (albumWheelLock) { e.preventDefault(); return; }
              var list = items();
              if (!list.length) return;
              var delta = (typeof e.deltaY === 'number') ? e.deltaY : 0;
              var threshold = 20; // ignore micro touches
              var dir = delta > threshold ? 1 : (delta < -threshold ? -1 : 0);
              if (dir === 0) return;
              e.preventDefault();
              albumWheelLock = true;
              var head = header();
              var headH = head ? head.offsetHeight : 0;
              var currentTop = window.scrollY + headH + 1;
              var currentIndex = 0;
              var minDist = Infinity;
              for (var i = 0; i < list.length; i++) {
                var elTop = list[i].offsetTop;
                var dist = Math.abs(elTop - currentTop);
                if (dist < minDist) { minDist = dist; currentIndex = i; }
              }
              var targetIndex = Math.min(Math.max(currentIndex + dir, 0), list.length - 1);
              var target = list[targetIndex];
              var targetScrollTop = (target.offsetTop + (target.offsetHeight / 2)) - (window.innerHeight / 2) + (headH / 2);
              window.scrollTo({ top: Math.max(targetScrollTop, 0), behavior: 'smooth' });
              window.setTimeout(function () { albumWheelLock = false; }, 600);
            };
            window.addEventListener('wheel', albumWheelHandler, { passive: false });
          }

          function disableAlbumWheelSnap() {
            if (!albumWheelHandler) return;
            window.removeEventListener('wheel', albumWheelHandler);
            albumWheelHandler = null;
            albumWheelLock = false;
          }


          // removed modal/lightbox
        })();
      });
    </script>
  </body>
  </html>


